{% extends "base.html" %}

{% block title %}Krishi Bhavan Marketplace - Public Catalog{% endblock %}

{% block extra_css %}
<style>
    .marketplace-header {
        background: linear-gradient(135deg, #198754 0%, #146c43 100%);
        color: white;
        padding: 4rem 0;
        margin-bottom: 3rem;
        border-radius: 0 0 50% 50% / 20px;
    }

    .product-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100%;
        border: none;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .product-img-wrapper {
        height: 200px;
        overflow: hidden;
        position: relative;
        background-color: #f1f1f1;
    }

    .product-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .product-card:hover .product-img {
        transform: scale(1.1);
    }

    .badge-float {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        font-size: 0.85rem;
        padding: 0.5em 0.8em;
    }

    .badge-category {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        backdrop-filter: blur(4px);
        background-color: rgba(255, 255, 255, 0.9);
        color: #198754;
        font-weight: 600;
        border-radius: 20px;
        padding: 0.4em 0.8em;
        font-size: 0.75rem;
    }

    .card-body {
        padding: 1.5rem;
    }

    .price-tag {
        font-size: 1.25rem;
        font-weight: 700;
        color: #198754;
    }

    .free-tag {
        color: #198754;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .btn-claim {
        border-radius: 50px;
        padding: 0.6rem 1.5rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.9rem;
    }

    /* Search Bar */
    .search-container {
        max-width: 600px;
        margin: -5.5rem auto 3rem;
        position: relative;
        z-index: 20;
    }

    .search-input {
        border-radius: 50px;
        padding: 1rem 1.5rem;
        border: none;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        font-size: 1.1rem;
    }

    .search-btn {
        position: absolute;
        right: 5px;
        top: 5px;
        border-radius: 40px;
        padding: 0.7rem 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-success sticky-top shadow-sm mb-0">
    <div class="container">
        <a class="navbar-brand fw-bold" href="{{ url_for('main.index') }}">
            <i class="bi bi-arrow-left-circle me-2"></i>Back to Portal
        </a>
        <div class="text-white d-none d-md-block opacity-75 ms-3 border-start ps-3">
            <small>Krishi Bhavan Marketplace</small>
        </div>
        <div class="d-flex align-items-center gap-2 ms-auto">
            {% if current_user.is_authenticated %}
            <div class="text-white me-2 d-none d-md-block">
                <small>Welcome, {{ current_user.full_name }}</small>
            </div>
            {% if current_user.role == 'farmer' %}
            <a href="{{ url_for('farmer.dashboard') }}" class="btn btn-light btn-sm rounded-pill px-3">
                <i class="bi bi-speedometer2 me-1"></i> Dashboard
            </a>
            {% elif current_user.role == 'expert' %}
            <a href="{{ url_for('expert.dashboard') }}" class="btn btn-light btn-sm rounded-pill px-3">
                <i class="bi bi-speedometer2 me-1"></i> Dashboard
            </a>
            {% elif current_user.role == 'krishi_bhavan_officer' %}
            <a href="{{ url_for('officer.dashboard') }}" class="btn btn-light btn-sm rounded-pill px-3">
                <i class="bi bi-speedometer2 me-1"></i> Dashboard
            </a>
            {% endif %}
            <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-light btn-sm rounded-circle" title="Logout">
                <i class="bi bi-box-arrow-right"></i>
            </a>
            {% else %}
            <div class="dropdown">
                <button class="btn btn-outline-light btn-sm dropdown-toggle rounded-pill px-3" type="button"
                    data-bs-toggle="dropdown">
                    <i class="bi bi-person-circle me-1"></i> Login / Register
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li>
                        <h6 class="dropdown-header text-success">For Farmers</h6>
                    </li>
                    <li><a class="dropdown-item" href="{{ url_for('auth.farmer_login') }}">Farmer Login</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('auth.farmer_register') }}">New Registration</a></li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li>
                        <h6 class="dropdown-header text-success">For Officials</h6>
                    </li>
                    <li><a class="dropdown-item" href="{{ url_for('auth.expert_login') }}">Agri-Expert Login</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('auth.krishi_bhavan_officer_login') }}">Officer
                            Login</a></li>
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</nav>

<!-- Hero Header -->
<div class="marketplace-header text-center mt-0">
    <div class="container">
        <h1 class="display-4 fw-bold mb-3">Krishi Bhavan Marketplace</h1>
        <p class="lead mb-4 opacity-75">Access subsidized seeds, fertilizers, and equipment directly from the
            government.</p>
    </div>
</div>

<div class="container pb-5">
    <!-- Search Bar -->
    <div class="search-container">
        <form action="" method="GET" class="d-flex position-relative">
            <input type="text" class="form-control search-input" placeholder="Search for seeds, fertilizers..."
                id="searchInput">
            <button class="btn btn-success search-btn" type="button" onclick="filterProducts()">
                <i class="bi bi-search"></i> Search
            </button>
        </form>
    </div>

    <!-- Products Grid -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="productsGrid">
        {% for product in products %}
        <div class="col product-item" data-name="{{ product.name|lower }}" data-category="{{ product.category|lower }}">
            <div class="card product-card">
                <div class="product-img-wrapper">
                    {% if product.image_path %}
                    <img src="{{ url_for('static', filename=product.image_path) }}" class="product-img"
                        alt="{{ product.name }}">
                    {% else %}
                    <!-- Placeholder Image based on type -->
                    <div class="d-flex align-items-center justify-content-center h-100 bg-light text-secondary">
                        <i class="bi bi-box-seam" style="font-size: 4rem;"></i>
                    </div>
                    {% endif %}

                    <!-- Badges -->
                    {% if product.is_free %}
                    <span class="badge bg-success badge-float rounded-pill shadow-sm">
                        <i class="bi bi-gift-fill me-1"></i> FREE
                    </span>
                    {% else %}
                    <span class="badge bg-secondary badge-float rounded-pill shadow-sm">SUBSIDIZED</span>
                    {% endif %}

                    {% if product.category %}
                    <span class="badge-category shadow-sm">{{ product.category }}</span>
                    {% endif %}
                </div>

                <div class="card-body d-flex flex-column">
                    <div class="mb-2 text-muted small text-uppercase fw-bold">{{ product.product_type }}</div>
                    <h5 class="card-title fw-bold mb-3">{{ product.name }}</h5>
                    <p class="card-text text-muted flex-grow-1 small">{{ product.description[:100] }}{% if
                        product.description|length > 100 %}...{% endif %}</p>

                    <div class="d-flex justify-content-between align-items-end mt-3">
                        <div>
                            <div class="small text-muted mb-1">Stock Left</div>
                            <div
                                class="fw-bold {% if product.stock_quantity < 10 %}text-danger{% else %}text-success{% endif %}">
                                {{ product.stock_quantity }} {{ product.unit }}s
                            </div>
                        </div>
                        <div class="text-end">
                            {% if product.is_free %}
                            <div class="free-tag">₹0.00</div>
                            {% else %}
                            <div class="price-tag">₹{{ "%.2f"|format(product.price_per_unit) }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <hr class="my-3 opacity-25">

                    <button class="btn btn-primary btn-claim w-100 shadow-sm" data-bs-toggle="modal"
                        data-bs-target="#claimModal"
                        onclick="setClaimDetails('{{ product.name }}', {{ product.id }}, {{ product.stock_quantity }})">
                        <i class="bi bi-bag-check-fill me-2"></i> Check Availability
                    </button>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12 text-center py-5">
            <div class="text-muted mb-3">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
            </div>
            <h4>No products available at the moment.</h4>
            <p class="text-muted">Please check back later or visit your local Krishi Bhavan.</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Claim/Info Modal -->
<div class="modal fade" id="claimModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-info-circle-fill me-2"></i> How to Claim
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <div class="mb-4">
                    <i class="bi bi-shop text-success" style="font-size: 3rem;"></i>
                </div>
                <h4 class="mb-3" id="modalProductName">Product Name</h4>
                <p class="text-muted mb-4">
                    This item is available for distribution at your local Krishi Bhavan.
                </p>

                <div class="card bg-light border-0 mb-4 text-start">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">Requirements for Collection:</h6>
                        <ul class="mb-0 ps-3 small text-muted">
                            <li class="mb-2">Valid Aadhar Card or Farmer ID Card</li>
                            <li class="mb-2">Copy of Land Tax Receipt (for seeds/fertilizers)</li>
                            <li class="mb-0">Please visit between 10:00 AM - 4:00 PM (Mon-Fri)</li>
                        </ul>
                    </div>
                </div>

                <div class="alert alert-warning border-0 d-flex align-items-center" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <div class="small text-start">
                        Stock is limited (<span id="modalStock">0</span> remaining). First come, first served.
                    </div>
                </div>

                <!-- Login button removed as per request - pure view only mode -->
            </div>
            <div class="modal-footer justify-content-center border-0 pb-4">
                <button type="button" class="btn btn-secondary px-4 rounded-pill" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function setClaimDetails(name, id, stock) {
        document.getElementById('modalProductName').textContent = name;
        document.getElementById('modalStock').textContent = stock;
    }

    function filterProducts() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const items = document.getElementsByClassName('product-item');

        for (let i = 0; i < items.length; i++) {
            const name = items[i].getAttribute('data-name');
            const category = items[i].getAttribute('data-category');
            if (name.includes(filter) || category.includes(filter)) {
                items[i].style.display = "";
            } else {
                items[i].style.display = "none";
            }
        }
    }

    // Live search
    document.getElementById('searchInput').addEventListener('keyup', filterProducts);
</script>
{% endblock %}