{% extends "base.html" %}

{% block title %}Chat with {{ expert.full_name }} - Farmer Portal{% endblock %}

{% block extra_css %}
<style>
    .chat-messages {
        height: 500px;
        overflow-y: auto;
        background: linear-gradient(135deg, #f0f8e8 0%, #e8f5e9 100%);
        padding: 20px;
        border-radius: 12px;
        border: 2px solid rgba(45, 80, 22, 0.1);
    }

    .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 10px;
        max-width: 70%;
    }

    .message.farmer {
        background: linear-gradient(135deg, #6b8e23 0%, #556b2f 100%);
        color: white;
        margin-left: auto;
        text-align: right;
        box-shadow: 0 2px 8px rgba(107, 142, 35, 0.3);
    }

    .message.expert {
        background: linear-gradient(135deg, #228b22 0%, #2d5016 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(45, 80, 22, 0.3);
    }

    .message-time {
        font-size: 0.75rem;
        opacity: 0.8;
    }
</style>
{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-dark mb-4" style="background: linear-gradient(135deg, #2d5016 0%, #228b22 100%) !important;">
    <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('farmer.chat_list') }}">
            <i class="bi bi-arrow-left me-2"></i><i class="bi bi-chat-dots-fill me-2"></i>Chat with Expert
        </a>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="bi bi-person-badge"></i> {{ expert.full_name }}
                        </h5>
                        {% if expert.expertise_area %}
                        <small>{{ expert.expertise_area }}</small>
                        {% endif %}
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="chat-messages" id="chatMessages">
                        {% if messages %}
                        {% for msg in messages %}
                        <div class="message {{ msg.sender_role }}">
                            <div>{{ msg.message }}</div>
                            {% if msg.image_path %}
                            <div class="mt-2"><img src="{{ url_for('static', filename='') }}{{ msg.image_path }}"
                                    alt="Chat image" class="img-fluid rounded" style="max-height:200px;"></div>
                            {% endif %}
                            <div class="message-time">{{ msg.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-chat-left-text" style="font-size: 3rem;"></i>
                            <p class="mt-3">No messages yet. Start the conversation!</p>
                        </div>
                        {% endif %}
                    </div>

                    <div class="card-footer">
                        <!-- Image Preview Container -->
                        <div id="imagePreviewContainer" class="d-none mb-2 position-relative"
                            style="width: fit-content;">
                            <img id="imagePreview" src="" alt="Preview" class="rounded border"
                                style="max-height: 100px; max-width: 150px;">
                            <button type="button"
                                class="btn-close position-absolute top-0 start-100 translate-middle bg-white rounded-circle shadow-sm p-1"
                                aria-label="Remove" onclick="clearImageSelection()" style="font-size: 0.7rem;"></button>
                        </div>

                        <form method="POST" id="chatForm" class="d-flex gap-2 align-items-end">
                            <input type="file" name="image" id="imageInput" class="d-none" accept="image/*">
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="document.getElementById('imageInput').click()" title="Attach Image">
                                <i class="bi bi-paperclip"></i>
                            </button>
                            <input type="text" name="message" id="messageInput" class="form-control"
                                placeholder="Type your message..." required>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send"></i> Send
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let lastMessageId = {{ last_message_id }};
    let isPolling = false;
    let pollTimeout = null;

    // Debug info: print expert id and whoami for troubleshooting (safe)
    console.log('[CHAT DEBUG] Farmer chat page loaded. expert.id=', {{ expert.id }}, 'url=', window.location.href);
    fetch('/auth/whoami').then(r=>r.json()).then(function(d){ console.log('[CHAT DEBUG] whoami', d); }).catch(function(e){ console.error('[CHAT DEBUG] whoami fetch error', e); });

    // Auto-scroll to bottom
    function scrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Initial scroll
    scrollToBottom();

    // Function to add new message to chat
    function addMessage(messageData) {
        const chatMessages = document.getElementById('chatMessages');

        // Remove empty state if exists
        const emptyState = chatMessages.querySelector('.text-center.text-muted');
        if (emptyState) {
            emptyState.remove();
        }

        // Create message element with ID for deduplication
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${messageData.sender_role}`;
        messageDiv.setAttribute('data-msg-id', messageData.id);

        let contentHtml = `<div>${escapeHtml(messageData.message)}</div>`;

        // Add image if exists
        if (messageData.image_path) {
            // Handle both temp blob URLs and server paths
            const imgSrc = messageData.image_path.startsWith('blob:')
                ? messageData.image_path
                : `{{ url_for('static', filename='') }}${messageData.image_path}`;

            contentHtml += `
            <div class="mt-2">
                <img src="${imgSrc}" class="img-fluid rounded" style="max-height: 200px;" alt="Shared image" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27200%27 height=%27150%27%3E%3Crect fill=%27%23ddd%27 width=%27200%27 height=%27150%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 font-family=%27Arial%27 font-size=%2714%27 fill=%27%23999%27%3EImage not found%3C/text%3E%3C/svg%3E'\"">
            </div>
        `;
        }

        messageDiv.innerHTML = `
        ${contentHtml}
        <div class="message-time">${messageData.time_display}</div>
    `;

        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Long-polling function
    function pollForNewMessages() {
        if (isPolling) return;

        isPolling = true;

        const pollUrl = `/farmer/chat/{{ expert.id }}/poll?last_message_id=${lastMessageId}`;
        console.log('[CHAT] Farmer polling:', pollUrl);

        fetch(pollUrl)
            .then(response => response.json())
            .then(data => {
                isPolling = false;

                if (data.new_messages && data.new_messages.length > 0) {
                    console.log('[CHAT] Received', data.new_messages.length, 'new messages');
                    // Deduplicate by ID to avoid rendering same message twice
                    const existingIds = new Set();
                    document.querySelectorAll('.message[data-msg-id]').forEach(el => {
                        existingIds.add(parseInt(el.getAttribute('data-msg-id')));
                    });

                    // Add new messages
                    data.new_messages.forEach(msg => {
                        // Skip our own messages and duplicates
                        if (msg.sender_role === 'farmer' || existingIds.has(msg.id)) {
                            console.log('[CHAT] Skipping message id', msg.id, 'role:', msg.sender_role);
                            return;
                        }
                        addMessage(msg);
                        existingIds.add(msg.id);
                    });

                    lastMessageId = data.last_message_id;

                    // Show notification sound/visual feedback
                    if (data.new_messages[0].sender_role === 'expert') {
                        // Play notification sound (optional)
                        // new Audio('/static/sounds/notification.mp3').play();
                    }
                }

                // Continue polling
                pollTimeout = setTimeout(pollForNewMessages, 2000); // Poll every 2 seconds
            })
            .catch(error => {
                console.error('Polling error:', error);
                isPolling = false;
                // Retry after 5 seconds on error
                pollTimeout = setTimeout(pollForNewMessages, 5000);
            });
    }

    // Start polling when page loads
    window.addEventListener('load', () => {
        pollForNewMessages();
    });

    // Stop polling when page is hidden
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            if (pollTimeout) {
                clearTimeout(pollTimeout);
                pollTimeout = null;
            }
        } else {
            pollForNewMessages();
        }
    });

    // Update unread count badge in navigation
    function updateUnreadBadge() {
        fetch('/farmer/chat/unread-count')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('chatUnreadBadge');
                if (badge) {
                    if (data.unread_count > 0) {
                        badge.textContent = data.unread_count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            })
            .catch(error => console.error('Error updating badge:', error));
    }

    // Update badge every 10 seconds
    setInterval(updateUnreadBadge, 10000);
    updateUnreadBadge();

    // Image Preview Logic
    const imageInput = document.getElementById('imageInput');
    const previewContainer = document.getElementById('imagePreviewContainer');
    const imagePreview = document.getElementById('imagePreview');

    imageInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                imagePreview.src = e.target.result;
                previewContainer.classList.remove('d-none');
            }
            reader.readAsDataURL(file);
        } else {
            clearImageSelection();
        }
    });

    function clearImageSelection() {
        imageInput.value = '';
        imagePreview.src = '';
        previewContainer.classList.add('d-none');
    }

    // Handle form submission - add message immediately to UI
    document.getElementById('chatForm').addEventListener('submit', function (e) {
        e.preventDefault(); // Prevent default form submission

        const messageInput = document.getElementById('messageInput');
        const imageInput = document.getElementById('imageInput');
        const message = messageInput.value.trim();
        const imageFile = imageInput.files[0];

        // Remove required attribute dynamically if image is selected
        if (imageFile) {
            messageInput.removeAttribute('required');
        } else {
            messageInput.setAttribute('required', 'true');
        }

        if (message || imageFile) {
            // Optimistic UI update
            const tempId = Date.now();
            const tempMessage = {
                id: tempId,
                message: message || (imageFile ? "Sent an image" : ""),
                sender_role: 'farmer',
                image_path: imageFile ? URL.createObjectURL(imageFile) : null,
                time_display: new Date().toLocaleString('en-US', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                })
            };
            addMessage(tempMessage);

            // Clear inputs immediately
            messageInput.value = '';
            // Don't clear image input value here directly as it's needed for sending,
            // but we call clearImageSelection later/or handle UI reset.
            // Actually, we need to send first, THEN clear? 
            // The optimistic update is done, we construct formData from elements.
            // But we can't clear the input 'imageInput' value before constructing formData!
            // Wait.. `const imageFile = imageInput.files[0];` reference is already grabbed.
            // So we can clear UI.
            clearImageSelection();

            // Send to server
            const formData = new FormData();
            formData.append('message', message);
            if (imageFile) {
                formData.append('image', imageFile);
            }

            console.log('[CHAT] Farmer submitting message:', message.substring(0, 50), 'with image:', !!imageFile);

            fetch(window.location.href, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Message saved successfully
                        console.log('[CHAT] Message sent successfully with server ID:', data.data?.id);
                        // IMPORTANT: Update lastMessageId so polling doesn't pick up our own message again
                        if (data.data && data.data.id) {
                            lastMessageId = data.data.id;
                            // Also update the temporary message with the real server ID
                            const tempMessages = document.querySelectorAll(`[data-msg-id="${tempId}"]`);
                            if (tempMessages.length > 0) {
                                tempMessages[0].setAttribute('data-msg-id', data.data.id);
                                console.log('[CHAT] Updated temp message ID from', tempId, 'to', data.data.id);
                            }
                        }
                    } else {
                        console.error('[CHAT] Error sending message:', data.message);
                        // Optional: Show error to user
                    }
                })
                .catch(error => {
                    console.error('[CHAT] Error:', error);
                });
        }
    });
</script>
{% endblock %}