{% extends "base.html" %}

{% block title %}Chat with {{ expert.full_name }} - Farmer Portal{% endblock %}

{% block extra_css %}
<style>
    .chat-messages {
        height: 500px;
        overflow-y: auto;
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
    }

    .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 10px;
        max-width: 70%;
    }

    .message.farmer {
        background-color: #0d6efd;
        color: white;
        margin-left: auto;
        text-align: right;
    }

    .message.expert {
        background-color: #198754;
        color: white;
    }

    .message-time {
        font-size: 0.75rem;
        opacity: 0.8;
    }
</style>
{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-dark bg-success mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('farmer.chat_list') }}">
            <i class="bi bi-arrow-left"></i> Back to Chat List
        </a>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="bi bi-person-badge"></i> {{ expert.full_name }}
                        </h5>
                        {% if expert.expertise_area %}
                        <small>{{ expert.expertise_area }}</small>
                        {% endif %}
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="chat-messages" id="chatMessages">
                        {% if messages %}
                        {% for msg in messages %}
                        <div class="message {{ msg.sender_role }}">
                            <div>{{ msg.message }}</div>
                            <div class="message-time">{{ msg.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-chat-left-text" style="font-size: 3rem;"></i>
                            <p class="mt-3">No messages yet. Start the conversation!</p>
                        </div>
                        {% endif %}
                    </div>

                    <div class="card-footer">
                        <!-- Image Preview Container -->
                        <div id="imagePreviewContainer" class="d-none mb-2 position-relative"
                            style="width: fit-content;">
                            <img id="imagePreview" src="" alt="Preview" class="rounded border"
                                style="max-height: 100px; max-width: 150px;">
                            <button type="button"
                                class="btn-close position-absolute top-0 start-100 translate-middle bg-white rounded-circle shadow-sm p-1"
                                aria-label="Remove" onclick="clearImageSelection()" style="font-size: 0.7rem;"></button>
                        </div>

                        <form method="POST" id="chatForm" class="d-flex gap-2 align-items-end">
                            <input type="file" name="image" id="imageInput" class="d-none" accept="image/*">
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="document.getElementById('imageInput').click()" title="Attach Image">
                                <i class="bi bi-paperclip"></i>
                            </button>
                            <input type="text" name="message" id="messageInput" class="form-control"
                                placeholder="Type your message..." required>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send"></i> Send
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let lastMessageId = {{ last_message_id }};
    let isPolling = false;
    let pollTimeout = null;

    // Auto-scroll to bottom
    function scrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Initial scroll
    scrollToBottom();

    // Function to add new message to chat
    function addMessage(messageData) {
        const chatMessages = document.getElementById('chatMessages');

        // Remove empty state if exists
        const emptyState = chatMessages.querySelector('.text-center.text-muted');
        if (emptyState) {
            emptyState.remove();
        }

        // Create message element
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${messageData.sender_role}`;

        let contentHtml = `<div>${escapeHtml(messageData.message)}</div>`;

        // Add image if exists
        if (messageData.image_path) {
            // Handle both temp blob URLs and server paths
            const imgSrc = messageData.image_path.startsWith('blob:')
                ? messageData.image_path
                : `{{ url_for('static', filename='') }}${messageData.image_path}`;

            contentHtml += `
            <div class="mt-2">
                <img src="${imgSrc}" class="img-fluid rounded" style="max-height: 200px;" alt="Shared image">
            </div>
        `;
        }

        messageDiv.innerHTML = `
        ${contentHtml}
        <div class="message-time">${messageData.time_display}</div>
    `;

        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Long-polling function
    function pollForNewMessages() {
        if (isPolling) return;

        isPolling = true;

        fetch(`/farmer/chat/{{ expert.id }}/poll?last_message_id=${lastMessageId}`)
            .then(response => response.json())
            .then(data => {
                isPolling = false;

                if (data.new_messages && data.new_messages.length > 0) {
                    // Add new messages
                    data.new_messages.forEach(msg => {
                        // Skip our own messages to avoid duplicates (optimistic UI)
                        if (msg.sender_role === 'farmer') return;
                        addMessage(msg);
                    });

                    lastMessageId = data.last_message_id;

                    // Show notification sound/visual feedback
                    if (data.new_messages[0].sender_role === 'expert') {
                        // Play notification sound (optional)
                        // new Audio('/static/sounds/notification.mp3').play();
                    }
                }

                // Continue polling
                pollTimeout = setTimeout(pollForNewMessages, 2000); // Poll every 2 seconds
            })
            .catch(error => {
                console.error('Polling error:', error);
                isPolling = false;
                // Retry after 5 seconds on error
                pollTimeout = setTimeout(pollForNewMessages, 5000);
            });
    }

    // Start polling when page loads
    window.addEventListener('load', () => {
        pollForNewMessages();
    });

    // Stop polling when page is hidden
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            if (pollTimeout) {
                clearTimeout(pollTimeout);
                pollTimeout = null;
            }
        } else {
            pollForNewMessages();
        }
    });

    // Update unread count badge in navigation
    function updateUnreadBadge() {
        fetch('/farmer/chat/unread-count')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('chatUnreadBadge');
                if (badge) {
                    if (data.unread_count > 0) {
                        badge.textContent = data.unread_count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            })
            .catch(error => console.error('Error updating badge:', error));
    }

    // Update badge every 10 seconds
    setInterval(updateUnreadBadge, 10000);
    updateUnreadBadge();

    // Image Preview Logic
    const imageInput = document.getElementById('imageInput');
    const previewContainer = document.getElementById('imagePreviewContainer');
    const imagePreview = document.getElementById('imagePreview');

    imageInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                imagePreview.src = e.target.result;
                previewContainer.classList.remove('d-none');
            }
            reader.readAsDataURL(file);
        } else {
            clearImageSelection();
        }
    });

    function clearImageSelection() {
        imageInput.value = '';
        imagePreview.src = '';
        previewContainer.classList.add('d-none');
    }

    // Handle form submission - add message immediately to UI
    document.getElementById('chatForm').addEventListener('submit', function (e) {
        e.preventDefault(); // Prevent default form submission

        const messageInput = document.getElementById('messageInput');
        const imageInput = document.getElementById('imageInput');
        const message = messageInput.value.trim();
        const imageFile = imageInput.files[0];

        // Remove required attribute dynamically if image is selected
        if (imageFile) {
            messageInput.removeAttribute('required');
        } else {
            messageInput.setAttribute('required', 'true');
        }

        if (message || imageFile) {
            // Optimistic UI update
            const tempId = Date.now();
            const tempMessage = {
                id: tempId,
                message: message || (imageFile ? "Sent an image" : ""),
                sender_role: 'farmer',
                image_path: imageFile ? URL.createObjectURL(imageFile) : null,
                time_display: new Date().toLocaleString('en-US', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                })
            };
            addMessage(tempMessage);

            // Clear inputs immediately
            messageInput.value = '';
            // Don't clear image input value here directly as it's needed for sending,
            // but we call clearImageSelection later/or handle UI reset.
            // Actually, we need to send first, THEN clear? 
            // The optimistic update is done, we construct formData from elements.
            // But we can't clear the input 'imageInput' value before constructing formData!
            // Wait.. `const imageFile = imageInput.files[0];` reference is already grabbed.
            // So we can clear UI.
            clearImageSelection();

            // Send to server
            const formData = new FormData();
            formData.append('message', message);
            if (imageFile) {
                formData.append('image', imageFile);
            }

            fetch(window.location.href, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Message saved successfully
                        console.log('Message sent successfully');
                        // IMPORTANT: Update lastMessageId so polling doesn't pick up our own message again
                        if (data.data && data.data.id) {
                            lastMessageId = data.data.id;
                        }
                    } else {
                        console.error('Error sending message:', data.message);
                        // Optional: Show error to user
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
    });
</script>
{% endblock %}